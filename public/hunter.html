<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>ROVER HUNTER</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --g:#00ff88;--r:#ff3344;--y:#ffcc00;--bg:rgba(0,0,0,.65);
  --font:'Courier New',monospace;
}
html,body{height:100%;overflow:hidden}
body{
  background:#000;color:#eee;font-family:var(--font);
  display:flex;flex-direction:column;
  user-select:none;-webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}
#wrap{flex:1;position:relative;display:flex;align-items:center;justify-content:center;background:#0a0a0a;overflow:hidden}
video{width:100%;height:100%;object-fit:contain;background:#000}
#touch{position:absolute;top:0;left:0;width:100%;height:100%;cursor:crosshair;z-index:5}
/* HUD overlays */
.hud{position:absolute;left:0;right:0;padding:6px 10px;z-index:10;background:var(--bg);font-size:12px;pointer-events:none}
.hud-top{top:0;display:flex;justify-content:space-between;align-items:center}
.hud-bot{bottom:0;pointer-events:auto}
.status{color:var(--g);font-weight:bold;font-size:13px}
.status.hunt{color:var(--y)}
.status.lost{color:var(--r)}
.sensor-row{margin-bottom:5px;color:#aaa;font-size:11px}
.ctrl{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.btn{
  padding:7px 16px;border:1px solid var(--g);background:rgba(0,255,136,.08);
  color:var(--g);font-family:var(--font);font-size:13px;cursor:pointer;
  border-radius:3px;pointer-events:auto;
}
.btn:active{background:rgba(0,255,136,.25)}
.btn.red{border-color:var(--r);color:var(--r);background:rgba(255,51,68,.08)}
.btn.red:active{background:rgba(255,51,68,.25)}
/* target preview thumbnail */
#preview{
  position:absolute;top:42px;right:8px;width:72px;height:72px;
  border:2px solid var(--g);background:#000;z-index:12;display:none;
  border-radius:4px;overflow:hidden;
}
#preview img{width:100%;height:100%;object-fit:cover}
/* confidence bar */
.cb{display:inline-block;width:50px;height:5px;background:#333;border-radius:3px;overflow:hidden;vertical-align:middle;margin-left:4px}
.cf{height:100%;transition:width .15s,background .15s}
/* crosshair animation */
.xhair{
  position:absolute;pointer-events:none;z-index:20;
  width:60px;height:60px;border:2px solid var(--g);border-radius:50%;
  transform:translate(-50%,-50%);animation:lockon .5s ease-out forwards;
}
@keyframes lockon{
  0%{width:100px;height:100px;opacity:.3}
  50%{width:50px;height:50px;opacity:1;border-width:3px}
  100%{width:30px;height:30px;opacity:0}
}
/* connection banner */
#conn{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  color:#666;font-size:14px;z-index:2;text-align:center;
}
</style>
</head>
<body>
<div id="wrap">
  <video id="vid" autoplay playsinline muted></video>
  <div id="touch"></div>
  <div id="conn">Connecting to rover stream...</div>

  <div class="hud hud-top">
    <span id="st" class="status">IDLE</span>
    <span id="cam" style="color:#666">CAM --</span>
    <span id="batt" style="color:#aaa">--V</span>
  </div>

  <div id="preview"><img id="timg" src="" alt="target"></div>

  <div class="hud hud-bot">
    <div class="sensor-row">
      <span id="sns">F:-- R:-- IR:.. G:--</span>
      <span id="cbar" style="display:none"> LOCK<span class="cb"><span id="cfill" class="cf"></span></span></span>
    </div>
    <div class="sensor-row">
      <span id="mot">M: L:-- R:-- | --</span>
    </div>
    <div class="ctrl">
      <button class="btn" onclick="cmd('start')">START</button>
      <button class="btn red" onclick="cmd('stop')">STOP</button>
      <button class="btn" onclick="cmd('scan')">SCAN</button>
      <button class="btn red" onclick="cmd('reset')">RESET</button>
    </div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const API = '';                      // same origin
const POLL_MS = 200;

/* ============ WebRTC via WHEP proxy ============ */
let pc = null;
let reconnTimer = null;

function iceReady(p){
  return new Promise(r=>{
    if(p.iceGatheringState==='complete') return r();
    const ck=()=>{if(p.iceGatheringState==='complete'){p.removeEventListener('icegatheringstatechange',ck);r();}};
    p.addEventListener('icegatheringstatechange',ck);
    setTimeout(r,4000); // safety
  });
}

async function startStream(){
  clearTimeout(reconnTimer);
  if(pc){try{pc.close();}catch(e){}}
  const el=document.getElementById('conn');
  el.textContent='Connecting to rover stream...';
  el.style.display='block';

  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.addTransceiver('video',{direction:'recvonly'});
  pc.ontrack=evt=>{
    document.getElementById('vid').srcObject=evt.streams[0];
    el.style.display='none';
  };
  pc.onconnectionstatechange=()=>{
    if(pc.connectionState==='failed'||pc.connectionState==='disconnected'){
      el.textContent='Stream lost – reconnecting...';
      el.style.display='block';
      reconnTimer=setTimeout(startStream,2000);
    }
  };
  try{
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    await iceReady(pc);
    const res=await fetch(API+'/api/whep',{
      method:'POST',headers:{'Content-Type':'application/sdp'},
      body:pc.localDescription.sdp
    });
    if(!res.ok) throw new Error('WHEP '+res.status);
    const ans=await res.text();
    await pc.setRemoteDescription({type:'answer',sdp:ans});
  }catch(e){
    console.error('WHEP error',e);
    el.textContent='Stream error – retrying...';
    reconnTimer=setTimeout(startStream,3000);
  }
}

/* ============ Touch-to-Pursue ============ */
const touchEl=document.getElementById('touch');
const vidEl=document.getElementById('vid');

function videoRect(){
  const vw=vidEl.videoWidth||1280, vh=vidEl.videoHeight||720;
  const r=vidEl.getBoundingClientRect();
  const s=Math.min(r.width/vw, r.height/vh);
  const w=vw*s, h=vh*s;
  return {x:r.left+(r.width-w)/2, y:r.top+(r.height-h)/2, w, h};
}

function onTouch(e){
  e.preventDefault();
  const cx=e.touches?e.touches[0].clientX:e.clientX;
  const cy=e.touches?e.touches[0].clientY:e.clientY;
  const vr=videoRect();
  let nx=(cx-vr.x)/vr.w, ny=(cy-vr.y)/vr.h;
  if(nx<0||nx>1||ny<0||ny>1) return; // outside video
  // crosshair animation
  const ch=document.createElement('div');
  ch.className='xhair';ch.style.left=cx+'px';ch.style.top=cy+'px';
  document.body.appendChild(ch);
  setTimeout(()=>ch.remove(),600);
  // send to server
  fetch(API+'/api/touch',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({x:nx,y:ny})
  }).then(r=>r.json()).then(d=>{
    if(d.ok){
      const p=document.getElementById('preview');
      const img=document.getElementById('timg');
      p.style.display='block';
      img.src=API+'/api/template.jpg?t='+Date.now();
    }
  }).catch(()=>{});
}
touchEl.addEventListener('click',onTouch);
touchEl.addEventListener('touchstart',onTouch,{passive:false});

/* ============ Commands ============ */
function cmd(c){
  fetch(API+'/api/command',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({cmd:c})
  }).catch(()=>{});
  if(c==='reset'||c==='stop'){
    document.getElementById('preview').style.display='none';
  }
}

/* ============ Telemetry Polling ============ */
async function poll(){
  try{
    const r=await fetch(API+'/api/status');
    const d=await r.json();
    // status
    const st=document.getElementById('st');
    st.textContent=d.status||'IDLE';
    st.className='status'+(d.found?' hunt':(d.mode==='TOUCH_TRACKING'&&!d.found?' lost':''));
    // camera
    document.getElementById('cam').textContent='CAM '+(d.camera||'--');
    // battery
    const bv=d.battery||0;
    const be=document.getElementById('batt');
    be.textContent=bv.toFixed(1)+'V';
    be.style.color=bv>10?'#aaa':bv>9?'var(--y)':'var(--r)';
    // sensors
    const s=d.sensors||{};
    document.getElementById('sns').textContent=
      `F:${s.front??'--'} R:${s.rear??'--'} `+
      `IR:${s.ir_left?'L':'.'}${s.ir_right?'R':'.'} `+
      `G:${(s.accel??0).toFixed(1)}`;
    // motors
    const m=d.motors||{};
    document.getElementById('mot').textContent=
      `M: L:${(m.L??0).toFixed(0)} R:${(m.R??0).toFixed(0)} | ${d.avoid||'--'}`;
    // confidence
    const cb=document.getElementById('cbar');
    const cf=document.getElementById('cfill');
    if(d.mode==='TOUCH_TRACKING'||d.mode==='TRACKING'){
      cb.style.display='inline';
      const p=Math.round((d.confidence||0)*100);
      cf.style.width=p+'%';
      cf.style.background=p>60?'var(--g)':p>35?'var(--y)':'var(--r)';
    }else{
      cb.style.display='none';
    }
    // preview visibility
    if(d.mode!=='TOUCH_TRACKING'){
      document.getElementById('preview').style.display='none';
    }
  }catch(e){}
}
setInterval(poll,POLL_MS);

/* ============ Init ============ */
startStream();
</script>
</body>
</html>
